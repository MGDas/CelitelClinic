<input type="hidden" id="doctorFetchID" name="doctorFetchID" value={{ doctor.id }} />

<script>
  

  document.addEventListener("DOMContentLoaded", () => {
    var doctorID = document.querySelector('#doctorFetchID').value
    fetch("/doctors/api/v0/all/" + doctorID)
      .then((response) => response.json())
      .then((data) => {
        window.rawData = data.dates
        // console.log("data: ", rawData)
      })
      .then(() => {
        if(!window.rawData.length){
          throw new Error()
        }
        // Создаём список клиник.
        var organizations = window.rawData.map((item) => {
          return item.organization.address
        })
        // Берём первую клинику, как временное решение.
        window.organizations = Array.from(new Set(organizations))[0]
      })
      .then(() => {
        // Создаём массив с датами и часами для первой клиники.
        var times = window.rawData.map((item) => {
          if(item.organization.address == window.organizations){
            var tempDate = item.date.split("-").reverse()
            tempDate.pop()
            switch(tempDate[1]){
              case "01":
                tempDate[1] = "Янв"
                break
              case "02":
                tempDate[1] = "Фев"
                break
              case "03":
                tempDate[1] = "Мар"
                break
              case "04":
                tempDate[1] = "Апр"
                break
              case "05":
                tempDate[1] = "Мая"
                break
              case "06":
                tempDate[1] = "Июн"
                break
              case "07":
                tempDate[1] = "Июл"
                break
              case "08":
                tempDate[1] = "Авг"
                break
              case "09":
                tempDate[1] = "Сен"
                break
              case "10":
                tempDate[1] = "Окт"
                break
              case "11":
                tempDate[1] = "Ноя"
                break
              case "12":
                tempDate[1] = "Дек"
                break
            }
            tempDate = tempDate.join(" ")

            return {
              "date": tempDate,
              "hours": item.timing,
              "rawDate": item.date
            }
          }
        })
        window.times = times
      })
      .then(() => {
        // Выводим на страницу адрес.
        var addressesWrapper = document.querySelector('.makeAnAppointment__addresses')
        var addressInput = document.createElement('input')
        addressInput.className = "makeAnAppointment__input visually-hidden"
        addressInput.setAttribute("data-address", window.organizations)
        addressInput.setAttribute("value", window.organizations)
        addressInput.setAttribute("type", "radio")
        addressInput.setAttribute("id", "address0")
        addressInput.setAttribute("name", "appointmentAddresses")
        addressInput.setAttribute("checked", "checked")

        var addressLabel = document.createElement('label')
        addressLabel.className = "makeAnAppointment__address"
        addressLabel.setAttribute("for", "address0")
        addressLabel.innerHTML = window.organizations

        addressesWrapper.append(addressInput)
        addressesWrapper.append(addressLabel)

      })
      .then(() => {
        // Выводим даты.
        var datesWrapper = document.querySelector('.makeAnAppointment__dates')
        var timesWrapper = document.querySelector('.makeAnAppointment__times')
       
        for(var i=0; i<window.times.length; i++){
          var dateInput = document.createElement('input')
          dateInput.className = "visually-hidden makeAnAppointment__dateInput"
          dateInput.setAttribute("data-appointmentdate", window.times[i].date)
          dateInput.setAttribute("value", window.times[i].date)
          dateInput.setAttribute("type", "radio")
          dateInput.setAttribute("id", "appointmentDates" + i)
          dateInput.setAttribute("name", "appointmentDates0")
          if(i==0){
            dateInput.setAttribute("checked", "appointmentAddresses")
          }

          var dateLabel = document.createElement('label')
          dateLabel.className = "makeAnAppointment__date"
          dateLabel.setAttribute("for", "appointmentDates" + i)
          dateLabel.innerHTML = window.times[i].date

          datesWrapper.append(dateInput)
          datesWrapper.append(dateLabel)

          // Создаём обёртку для часов.
          var dayWrapper = document.createElement('div')
          if(i == 0){
            dayWrapper.className = "makeAnAppointment__day makeAnAppointment__day--active"
          } else {
            dayWrapper.className = "makeAnAppointment__day"
          }
          dayWrapper.setAttribute("data-appointmentday", window.times[i].date)

          // Выводим часы.
          for(var j=0; j<window.times[i].hours.length; j++){

            var randomNumber = Math.random() * Math.random()
            var timeInput = document.createElement('input')

            timeInput.className = "visually-hidden makeAnAppointment__hoursInput"
            timeInput.setAttribute("type", "radio")
            timeInput.setAttribute("id", "appointmentTime" + randomNumber)
            timeInput.setAttribute("name", "appointmentTime")
            if(!window.times[i].hours[j].free){
              timeInput.setAttribute("disabled", "disabled")
            }

            timeInput.setAttribute("value", window.times[i].rawDate + "T" + window.times[i].hours[j].hour + ":00")

            var timeLabel = document.createElement('label')
            if(window.times[i].hours[j].free){
              timeLabel.className = "makeAnAppointment__time"
            } else {
              timeLabel.className = "makeAnAppointment__time makeAnAppointment__time--unavailable"
            }
            timeLabel.setAttribute("for", "appointmentTime" + randomNumber)
            timeLabel.setAttribute("aria-label", window.times[i].date + ", " + window.times[i].hours[j].hour)
            timeLabel.innerHTML = window.times[i].hours[j].hour

            dayWrapper.append(timeInput)
            dayWrapper.append(timeLabel)
          }
          
          timesWrapper.append(dayWrapper)
        }
      })
      .catch((err) => {
        console.log("Ошибка: ", err)
      })
  })




</script>


<!-- Форма отправляется по адресу в data-action и ожидает ответа "1", если всё нормально. В action указывается адрес, куда надо перекидывать для оплаты. В data-name прописывается имя врача. В data-desk - описание. В data-photo - адрес его фотографии.-->
<form class="doctorPage__order makeAnAppointment" action="#" data-action="#" data-name="Зарема Алиевна Алиева" data-desk="детский врач-невролог. Опыт работы — 5 лет" data-photo="assets/doctorCardPhoto.png">
  <input type="hidden" id="doctorCode" name="doctorCode" value={{ doctor.code }} />
  <input type="hidden" id="doctorID" name="doctorID" value={{ doctor.id }} />

  <div class="makeAnAppointment__addresses"></div>

  <div class="makeAnAppointment__wrapper makeAnAppointment__wrapper--active" data-address="Гоголя, 24">
    <div class="makeAnAppointment__dates"></div>

    <div class="makeAnAppointment__times"></div>
  </div>
  
                  <section class="orderModal orderModal--step1">
                    <header class="orderModal__header">
                        <h3 class="orderModal__title">Запись к врачу и оплата</h3>
                        <button class="orderModal__close" type="button" aria-label="Закрыть">
                                    <svg width="15" height="15" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#close"></use>
                                    </svg>
                        </button>
                    </header>
                    <div class="orderModal__body">
                        <div class="orderModal__wrapper">
                                <div class="orderModal__photo">
                                {% if doctor.avatar %}
                                    <img src="{{ doctor.avatar.url }}" alt="" width="80" height="80">
                                {% else %}
                                    <img src="" alt="" width="80" height="80">
                                {% endif %}
                            </div>
                            <div class="orderModal__wrap">
                                <div class="orderModal__name">{{ doctor.full_name }}</div>
                                <div class="orderModal__desc">
                                    {% if doctor.specialization %}
                                    {% for spec in doctor.specialization.all %}
                                        {{ spec }}
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="orderModal__body">
                            <div class="orderModal__input orderModal__input--withBorder">
                                <label class="orderModal__label" for="orderModalAddress">Поликлиника</label>
                                <input type="text" readOnly disabled tabindex="-1" name="orderModalAddress" id="orderModalAddress">
                            </div>
                            <div class="orderModal__input orderModal__input--withBorder">
                                <label class="orderModal__label" for="orderModalTime">Дата и время приёма</label>
                                <input type="text" readOnly disabled tabindex="-1" name="orderModalTime" id="orderModalTime">
                            </div>
                            <div class="orderModal__input">
                                <label class="orderModal__label" for="orderModalName">ФИО</label>
                                <input type="text" name="orderModalName" id="orderModalName" placeholder="Магомедов Магомед Магомедович" required>
                            </div>
                            <div class="orderModal__input">
                                <label class="orderModal__label" for="orderModalPhone">Телефон</label>
                                <input type="text" name="orderModalPhone" id="orderModalPhone" placeholder="+7 000 111-22-33" required>
                            </div>
                            <div class="orderModal__input">
                                <label class="orderModal__label" for="orderModalBirthday">Дата рождения</label>
                                <input type="date" name="orderModalBirthday" id="orderModalBirthday" required>
                            </div>
                            <div class="orderModal__input">
                                <span class="orderModal__label">Пол</span>
                                <input type="radio" name="orderModalGender" id="orderModalGenderM" value="М" required style="width: auto; margin: 1px 5px 0 0">
                                <label for="orderModalGenderM">М</label>
                                <input type="radio" name="orderModalGender" id="orderModalGenderF" value="Ж" required style="width: auto; margin: 1px 5px 0 10px">
                                <label for="orderModalGenderF">Ж</label>
                            </div>
<!--                             <button class="orderModal__btn orderModal__btn--prefer" type="submit" id="orderModalPay">Записаться и оплатить</button>
 -->                            <button class="orderModal__btn" type="button" id="orderModalNoPay">Записаться</button>
                            <p class="orderModal__note">Я согласен с условиями обработки&nbsp;<a href="#" target="_blank">персональных данных</a></p>
                        </div>
                    </div>
                </section>
                <section class="orderModal orderModal--success">
                    <header class="orderModal__header">
                        <h3 class="orderModal__title">Запись к врачу и оплата</h3>
                        <button class="orderModal__close" type="button" aria-label="Закрыть">
                                    <svg width="15" height="15" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#close"></use>
                                    </svg>
                        </button>
                    </header>
                    <div class="orderModal__body">
                        <div class="orderModal__wrapper">
                                    <svg width="100" height="76" aria-hidden="true">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#correct-signal"></use>
                                    </svg>
                            <h2 class="orderModal__successHeading">Спасибо за запись!</h2>
                            <p class="orderModal__successText">Скоро мы свяжемся по телефону для уточнения записи</p>
                        </div>
                    </div>
                </section>
  
</form>